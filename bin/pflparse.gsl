#   'Parse' engine for PFL
#
#   Generated by iMatix GSLgen
#   For copyright and license please see project license.
#

function pfl_parse_pfl (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in pfl")
    endif
    if !defined (.[ofl])
        pfl_parse_error ("Required attribute 'ofl' not defined in pfl")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "include"
        elsif name () = "screen"
        elsif name () = "defaults"
        else
            pfl_parse_error ("<$(name ())> not allowed in pfl")
        endif
    endfor

    #    Process each set of entities separately
    for [include]
        pfl_parse_pfl_include ('include')
    endfor
    for [screen]
        pfl_parse_screen ('screen')
    endfor
    for [defaults]
        pfl_parse_defaults ('defaults')
    endfor
endfunction

function pfl_parse_pfl_include (tag)
    if !defined (.[filename])
        pfl_parse_error ("Required attribute 'filename' not defined in include")
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in include")
    endfor
endfunction

function pfl_parse_screen (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in screen")
    endif
    if (.[main]?"") = ""
        .[main] = "0"
    endif
    if defined (.[main])
        if    .[main] ?= "0"
        elsif .[main] ?= "1"
        else
            pfl_parse_error ("Attribute 'main' has illegal value '$(.[main]?)' in screen")
        endif
    endif
    if (.[limit]?"") = ""
        .[limit] = "20"
    endif
    if (.[hints]?"") = ""
        .[hints] = "1"
    endif
    if defined (.[hints])
        if    .[hints] ?= "0"
        elsif .[hints] ?= "1"
        else
            pfl_parse_error ("Attribute 'hints' has illegal value '$(.[hints]?)' in screen")
        endif
    endif
    if count (pfl.screen, count.name ?= screen.name) > 1
        error ("screen '$(name)' is not unique")
    endif
    for pfl.defaults
        for . as child
            if name () = "property"
                screen.$(child.name) ?= child.value
            else
                copy child to screen
            endif
        endfor
    endfor

    screen.datesplit ?= 1
    if !defined (screen.skin)
        screen.banner_color ?= "#525a7b"
        screen.formbg_color ?= "#e7e1ed"
        screen.thead_color  ?= "#525a7b"
        screen.trow1_color  ?= "#e7e1ed"
        screen.trow2_color  ?= "#ffffff"
    endif
    pfl_parse_screen_element ('screen')
endfunction

function pfl_parse_screen_element (tag)
    if count (page) < 1
        pfl_parse_error ("<page> required in screen element")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "use"
        elsif name () = "var"
        elsif name () = "enum"
        elsif name () = "global"
        elsif name () = "match"
        elsif name () = "queryarg"
        elsif name () = "page"
        elsif name () = "handler"
        else
            pfl_parse_error ("<$(name ())> not allowed in screen element")
        endif
    endfor

    #    Process each set of entities separately
    for [use]
        pfl_parse_use ('use')
    endfor
    for [var]
        pfl_parse_var ('var')
    endfor
    for [enum]
        pfl_parse_enum ('enum')
    endfor
    for [global]
        pfl_parse_global ('global')
    endfor
    for [match]
        pfl_parse_match ('match')
    endfor
    for [queryarg]
        pfl_parse_queryarg ('queryarg')
    endfor
    for [page]
        pfl_parse_page ('page')
    endfor
    for [handler]
        pfl_parse_screen_handler ('handler')
    endfor
endfunction

function pfl_parse_use (tag)
    if !defined (.[object])
        pfl_parse_error ("Required attribute 'object' not defined in use")
    endif
    if count (ofl.object, name = use.object) = 0
        pfl_parse_error ("'$(use.object)' is not a defined object")
    elsif count (screen.use, object = use.object) > 1 & item () > 1
        use.object = ""
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in use")
    endfor
endfunction

function pfl_parse_var (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in var")
    endif
    if (.[type]?"") = ""
        .[type] = "textual"
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in var")
        endif
    endif
    if count (screen.var, count.name ?= var.name) > 1
        pfl_parse_error ("variable '$(name)' is not unique")
    elsif defined (var.domain)
        if count (dfl.domain, count.name = var.domain) = 0
            pfl_parse_error ("Domain '$(domain)' not found in DFL")
        endif
        for dfl.domain where name = var.domain
            var.type = domain.type
        endfor
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in var")
    endfor
endfunction

function pfl_parse_global (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in global")
    endif
    if (.[type]?"") = ""
        .[type] = "textual"
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in global")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in global")
    endfor
endfunction

function pfl_parse_enum (tag)
    if !defined (.[domain])
        pfl_parse_error ("Required attribute 'domain' not defined in enum")
    endif
    if count (screen.enum, count.domain ?= enum.domain) > 1
        pfl_parse_error ("domain '$(domain)' is used more than once in screen")
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in enum")
    endfor
endfunction

function pfl_parse_match (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in match")
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in match")
    endfor
endfunction

function pfl_parse_queryarg (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in queryarg")
    endif
    if !defined (.[value])
        pfl_parse_error ("Required attribute 'value' not defined in queryarg")
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in queryarg")
    endfor
endfunction

function pfl_parse_page (tag)
    if (.[name]?"") = ""
        .[name] = "unnamed"
    endif
    if count (screen.page, count.name ?= page.name) > 1
        pfl_parse_error ("page '$(page.name)' is not unique")
    endif
    if !defined (page.object) & count (screen.use)
        page.object = screen-> use.object
    endif
    if count (page.toolbar) = 0
        for page. as child
            new toolbar before child
            endnew
            last
        endfor
    endif

    #   Define all object view fields as screen vars
    if defined (page.view)
        assume_screen_view (object, page.view)
    endif
    if count (field)
        pfl_parse_error ("do not define 'field' items at the page level")
    endif
    pfl_parse_page_element ('page')
endfunction

function pfl_parse_page_element (tag)
    if count (toolbar) > 1
        pfl_parse_error ("more than one <toolbar> defined in page element")
    endif
    if count (form) < 1
        pfl_parse_error ("<form> required in page element")
    endif
    if count (form) > 1
        pfl_parse_error ("more than one <form> defined in page element")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "toolbar"
        elsif name () = "form"
        elsif name () = "handler"
        else
            pfl_parse_error ("<$(name ())> not allowed in page element")
        endif
    endfor

    #    Process each set of entities separately
    for [toolbar]
        pfl_parse_toolbar ('toolbar')
    endfor
    for [form]
        pfl_parse_form ('form')
    endfor
    for [handler]
        pfl_parse_page_handler ('handler')
    endfor
endfunction

function pfl_parse_toolbar (tag)
    if (.[visible]?"") = ""
        .[visible] = "1"
    endif
    if defined (.[visible])
        if    .[visible] ?= "0"
        elsif .[visible] ?= "1"
        else
            pfl_parse_error ("Attribute 'visible' has illegal value '$(.[visible]?)' in toolbar")
        endif
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "action"
        else
            pfl_parse_error ("<$(name ())> not allowed in toolbar")
        endif
    endfor

    #    Process each set of entities separately
    for [action]
        pfl_parse_toolbar_action ('action')
    endfor
endfunction

function pfl_parse_toolbar_action (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in action")
    endif
    if (.[fields]?"") = ""
        .[fields] = "0"
    endif
    if defined (.[fields])
        if    .[fields] ?= "0"
        elsif .[fields] ?= "1"
        else
            pfl_parse_error ("Attribute 'fields' has illegal value '$(.[fields]?)' in action")
        endif
    endif
    if (.[confirm]?"") = ""
        .[confirm] = ""
    endif
    if (.[active]?"") = ""
        .[active] = "1"
    endif
    if defined (.[active])
        if    .[active] ?= "0"
        elsif .[active] ?= "1"
        else
            pfl_parse_error ("Attribute 'active' has illegal value '$(.[active]?)' in action")
        endif
    endif
    if (.[shortcut]?"") = ""
        .[shortcut] = ""
    endif
    if count (toolbar.action, count.name = action.name) > 1
        pfl_parse_error ("action '$(action.name)' is not unique in toolbar")
    endif
    action_defaults ()
    for .
        pfl_parse_error ("<$(name ())> not allowed in action")
    endfor
endfunction

function pfl_parse_form (tag)
    if (.[mode]?"") = ""
        .[mode] = "output"
    endif
    if defined (.[mode])
        if    .[mode] ?= "output"
        elsif .[mode] ?= "input"
        else
            pfl_parse_error ("Attribute 'mode' has illegal value '$(.[mode]?)' in form")
        endif
    endif
    expand_wildcards_if_any ()
    pfl_parse_form_element ('form')
endfunction

function pfl_parse_form_element (tag)
    if count (banner) > 1
        pfl_parse_error ("more than one <banner> defined in form element")
    endif
    if count (hints) > 1
        pfl_parse_error ("more than one <hints> defined in form element")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "banner"
        elsif name () = "hints"
        elsif name () = "field"
        elsif name () = "text"
        elsif name () = "line"
        elsif name () = "action"
        elsif name () = "if"
        elsif name () = "layout"
        elsif name () = "summary"
        elsif name () = "index"
        else
            pfl_parse_error ("<$(name ())> not allowed in form element")
        endif
    endfor

    #    Process each set of entities separately
    for [banner]
        pfl_parse_form_banner ('banner')
    endfor
    for [hints]
        pfl_parse_form_hints ('hints')
    endfor
    for [field]
        pfl_parse_form_field ('field')
    endfor
    for [text]
        pfl_parse_form_text ('text')
    endfor
    for [line]
        pfl_parse_form_line ('line')
    endfor
    for [action]
        pfl_parse_form_action ('action')
    endfor
    for [if]
        pfl_parse_form_if_block ('if')
    endfor
    for [layout]
        pfl_parse_layout_block ('layout')
    endfor
    for [summary]
        pfl_parse_summary_block ('summary')
    endfor
    for [index]
        pfl_parse_page_index ('index')
    endfor
endfunction

function pfl_parse_form_banner (tag)
    banner.label ?= "Form banner"
    for .
        pfl_parse_error ("<$(name ())> not allowed in banner")
    endfor
endfunction

function pfl_parse_form_hints (tag)
    form.hints = 1
    pfl_parse_form_hint_element ('hints')
endfunction

function pfl_parse_form_hint_element (tag)
    #    Check that all entities are valid here
    for . as entity
        if    name () = "hint"
        elsif name () = "text"
        elsif name () = "action"
        elsif name () = "field"
        elsif name () = "if"
        else
            pfl_parse_error ("<$(name ())> not allowed in form hint element")
        endif
    endfor

    #    Process each set of entities separately
    for [hint]
        pfl_parse_form_hint ('hint')
    endfor
    for [text]
        pfl_parse_form_hint_text ('text')
    endfor
    for [action]
        pfl_parse_form_action ('action')
    endfor
    for [field]
        pfl_parse_form_field ('field')
    endfor
    for [if]
        pfl_parse_form_hint_if_block ('if')
    endfor
endfunction

function pfl_parse_form_hint (tag)
    for .
        pfl_parse_error ("<$(name ())> not allowed in hint")
    endfor
endfunction

function pfl_parse_form_hint_text (tag)
    if (.[before]?"") = ""
        .[before] = "0"
    endif
    if (.[after]?"") = ""
        .[after] = "0"
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in text")
        endif
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in text")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in text")
    endfor
endfunction

function pfl_parse_form_hint_if_block (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    if !defined (condition)
        pfl_parse_error ("no condition defined for if block")
    endif
    pfl_parse_form_hint_element ('if')
endfunction

function pfl_parse_form_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    parse_top_level_field ("plain")
    #    Check that all entities are valid here
    for . as entity
        if    name () = "lookup"
        elsif name () = "sublist"
        elsif name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [lookup]
        pfl_parse_form_lookup_block ('lookup')
    endfor
    for [sublist]
        pfl_parse_sublist_block ('sublist')
    endfor
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_form_lookup_block (tag)
    if count (field) < 1
        pfl_parse_error ("<field> required in lookup")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        else
            pfl_parse_error ("<$(name ())> not allowed in lookup")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_form_lookup_field ('field')
    endfor
    parse_lookup_block ()
endfunction

function pfl_parse_form_lookup_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_field_rule (tag)
    for .
        pfl_parse_error ("<$(name ())> not allowed in rule")
    endfor
endfunction

function pfl_parse_field_value (tag)
    if !defined (.[key])
        pfl_parse_error ("Required attribute 'key' not defined in value")
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in value")
    endfor
endfunction

function pfl_parse_sublist_block (tag)
    if (.[occurs]?"") = ""
        .[occurs] = "5"
    endif
    expand_wildcards_if_any ()
    sublist.parent = field.name
    pfl_parse_sublist_element ('sublist')
endfunction

function pfl_parse_sublist_element (tag)
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        elsif name () = "text"
        elsif name () = "action"
        elsif name () = "if"
        else
            pfl_parse_error ("<$(name ())> not allowed in sublist element")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_sublist_field ('field')
    endfor
    for [text]
        pfl_parse_sublist_text ('text')
    endfor
    for [action]
        pfl_parse_sublist_action ('action')
    endfor
    for [if]
        pfl_parse_sublist_if_block ('if')
    endfor
endfunction

function pfl_parse_sublist_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "lookup"
        elsif name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [lookup]
        pfl_parse_sublist_lookup_block ('lookup')
    endfor
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_sublist_lookup_block (tag)
    if count (field) < 1
        pfl_parse_error ("<field> required in lookup")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        else
            pfl_parse_error ("<$(name ())> not allowed in lookup")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_sublist_lookup_field ('field')
    endfor
    parse_lookup_block ()
endfunction

function pfl_parse_sublist_lookup_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_sublist_text (tag)
    if (.[before]?"") = ""
        .[before] = "0"
    endif
    if (.[after]?"") = ""
        .[after] = "0"
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in text")
        endif
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in text")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in text")
    endfor
endfunction

function pfl_parse_sublist_action (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in action")
    endif
    if (.[fields]?"") = ""
        .[fields] = "0"
    endif
    if defined (.[fields])
        if    .[fields] ?= "0"
        elsif .[fields] ?= "1"
        else
            pfl_parse_error ("Attribute 'fields' has illegal value '$(.[fields]?)' in action")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "link"
        elsif .[type] ?= "button"
        elsif .[type] ?= "image"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in action")
        endif
    endif
    if (.[style]?"") = ""
        .[style] = "action"
    endif
    if (.[confirm]?"") = ""
        .[confirm] = ""
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in action")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in action")
        endif
    endif
    if defined (.[toolbar])
        if    .[toolbar] ?= "0"
        elsif .[toolbar] ?= "1"
        else
            pfl_parse_error ("Attribute 'toolbar' has illegal value '$(.[toolbar]?)' in action")
        endif
    endif
    if (.[active]?"") = ""
        .[active] = "1"
    endif
    if defined (.[active])
        if    .[active] ?= "0"
        elsif .[active] ?= "1"
        else
            pfl_parse_error ("Attribute 'active' has illegal value '$(.[active]?)' in action")
        endif
    endif
    if (.[shortcut]?"") = ""
        .[shortcut] = ""
    endif
    if defined (.[separator])
        if    .[separator] ?= "0"
        elsif .[separator] ?= "1"
        else
            pfl_parse_error ("Attribute 'separator' has illegal value '$(.[separator]?)' in action")
        endif
    endif
    action_defaults ()
    for .
        pfl_parse_error ("<$(name ())> not allowed in action")
    endfor
endfunction

function pfl_parse_sublist_if_block (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    if !defined (condition)
        pfl_parse_error ("no condition defined for if block")
    endif
    pfl_parse_sublist_element ('if')
endfunction

function pfl_parse_form_text (tag)
    if (.[before]?"") = ""
        .[before] = "0"
    endif
    if (.[after]?"") = ""
        .[after] = "0"
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in text")
        endif
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in text")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in text")
    endfor
endfunction

function pfl_parse_form_line (tag)
    for .
        pfl_parse_error ("<$(name ())> not allowed in line")
    endfor
endfunction

function pfl_parse_form_action (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in action")
    endif
    if (.[fields]?"") = ""
        .[fields] = "0"
    endif
    if defined (.[fields])
        if    .[fields] ?= "0"
        elsif .[fields] ?= "1"
        else
            pfl_parse_error ("Attribute 'fields' has illegal value '$(.[fields]?)' in action")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "link"
        elsif .[type] ?= "button"
        elsif .[type] ?= "image"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in action")
        endif
    endif
    if (.[style]?"") = ""
        .[style] = "action"
    endif
    if (.[confirm]?"") = ""
        .[confirm] = ""
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in action")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in action")
        endif
    endif
    if defined (.[toolbar])
        if    .[toolbar] ?= "0"
        elsif .[toolbar] ?= "1"
        else
            pfl_parse_error ("Attribute 'toolbar' has illegal value '$(.[toolbar]?)' in action")
        endif
    endif
    if (.[active]?"") = ""
        .[active] = "1"
    endif
    if defined (.[active])
        if    .[active] ?= "0"
        elsif .[active] ?= "1"
        else
            pfl_parse_error ("Attribute 'active' has illegal value '$(.[active]?)' in action")
        endif
    endif
    if (.[shortcut]?"") = ""
        .[shortcut] = ""
    endif
    if defined (.[separator])
        if    .[separator] ?= "0"
        elsif .[separator] ?= "1"
        else
            pfl_parse_error ("Attribute 'separator' has illegal value '$(.[separator]?)' in action")
        endif
    endif
    action_defaults ()
    for .
        pfl_parse_error ("<$(name ())> not allowed in action")
    endfor
endfunction

function pfl_parse_form_if_block (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    if !defined (condition)
        pfl_parse_error ("no condition defined for if block")
    endif
    pfl_parse_form_element ('if')
endfunction

function pfl_parse_layout_block (tag)
    expand_wildcards_if_any ()
    pfl_parse_layout_element ('layout')
endfunction

function pfl_parse_layout_element (tag)
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        elsif name () = "text"
        elsif name () = "line"
        elsif name () = "action"
        elsif name () = "if"
        else
            pfl_parse_error ("<$(name ())> not allowed in layout element")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_layout_field ('field')
    endfor
    for [text]
        pfl_parse_layout_text ('text')
    endfor
    for [line]
        pfl_parse_layout_line ('line')
    endfor
    for [action]
        pfl_parse_layout_action ('action')
    endfor
    for [if]
        pfl_parse_layout_if_block ('if')
    endfor
endfunction

function pfl_parse_layout_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    parse_top_level_field ("layout")
    #    Check that all entities are valid here
    for . as entity
        if    name () = "lookup"
        elsif name () = "sublist"
        elsif name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [lookup]
        pfl_parse_layout_lookup_block ('lookup')
    endfor
    for [sublist]
        pfl_parse_sublist_block ('sublist')
    endfor
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_layout_lookup_block (tag)
    if count (field) < 1
        pfl_parse_error ("<field> required in lookup")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        else
            pfl_parse_error ("<$(name ())> not allowed in lookup")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_layout_lookup_field ('field')
    endfor
    parse_lookup_block ()
endfunction

function pfl_parse_layout_lookup_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_layout_text (tag)
    if (.[before]?"") = ""
        .[before] = "0"
    endif
    if (.[after]?"") = ""
        .[after] = "0"
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in text")
        endif
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in text")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in text")
    endfor
endfunction

function pfl_parse_layout_line (tag)
    for .
        pfl_parse_error ("<$(name ())> not allowed in line")
    endfor
endfunction

function pfl_parse_layout_action (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in action")
    endif
    if (.[fields]?"") = ""
        .[fields] = "0"
    endif
    if defined (.[fields])
        if    .[fields] ?= "0"
        elsif .[fields] ?= "1"
        else
            pfl_parse_error ("Attribute 'fields' has illegal value '$(.[fields]?)' in action")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "link"
        elsif .[type] ?= "button"
        elsif .[type] ?= "image"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in action")
        endif
    endif
    if (.[style]?"") = ""
        .[style] = "action"
    endif
    if (.[confirm]?"") = ""
        .[confirm] = ""
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in action")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in action")
        endif
    endif
    if defined (.[toolbar])
        if    .[toolbar] ?= "0"
        elsif .[toolbar] ?= "1"
        else
            pfl_parse_error ("Attribute 'toolbar' has illegal value '$(.[toolbar]?)' in action")
        endif
    endif
    if (.[active]?"") = ""
        .[active] = "1"
    endif
    if defined (.[active])
        if    .[active] ?= "0"
        elsif .[active] ?= "1"
        else
            pfl_parse_error ("Attribute 'active' has illegal value '$(.[active]?)' in action")
        endif
    endif
    if (.[shortcut]?"") = ""
        .[shortcut] = ""
    endif
    if defined (.[separator])
        if    .[separator] ?= "0"
        elsif .[separator] ?= "1"
        else
            pfl_parse_error ("Attribute 'separator' has illegal value '$(.[separator]?)' in action")
        endif
    endif
    action_defaults ()
    for .
        pfl_parse_error ("<$(name ())> not allowed in action")
    endfor
endfunction

function pfl_parse_layout_if_block (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    if !defined (condition)
        pfl_parse_error ("no condition defined for if block")
    endif
    pfl_parse_layout_element ('if')
endfunction

function pfl_parse_summary_block (tag)
    if defined (summary.alpha)
        screen.alpha = 1
    endif
    if defined (summary.filter)
        screen.filter = 1
    endif
    expand_wildcards_if_any ()

    #   Implement checklist field
    if checklist ?= 1
        for summary.field as first where item () = 1
            new field before first
               field.name  = "checklist"
               field.type  = "boolean"
               field.label = ""
            endnew
        endfor
        new var to screen
            var.name   = "fld_checklist"
            var.type   = "boolean"
            var.occurs = screen.limit? 20
            var.value  = 0
        endnew
    endif
    pfl_parse_summary_element ('summary')
    if count (field, count.attr = "click" | count.attr = "input") = 0 \
    &  count (action) = 0
        for field where hidden = 0 & attr = "plain"
            attr = "click"
            last
        endfor
    endif
endfunction

function pfl_parse_summary_element (tag)
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        elsif name () = "text"
        elsif name () = "action"
        elsif name () = "if"
        else
            pfl_parse_error ("<$(name ())> not allowed in summary element")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_summary_field ('field')
    endfor
    for [text]
        pfl_parse_summary_text ('text')
    endfor
    for [action]
        pfl_parse_summary_action ('action')
    endfor
    for [if]
        pfl_parse_summary_if_block ('if')
    endfor
endfunction

function pfl_parse_summary_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    parse_top_level_field ("summary")
    #    Check that all entities are valid here
    for . as entity
        if    name () = "lookup"
        elsif name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [lookup]
        pfl_parse_summary_lookup_block ('lookup')
    endfor
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_summary_lookup_block (tag)
    if count (field) < 1
        pfl_parse_error ("<field> required in lookup")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "field"
        else
            pfl_parse_error ("<$(name ())> not allowed in lookup")
        endif
    endfor

    #    Process each set of entities separately
    for [field]
        pfl_parse_summary_lookup_field ('field')
    endfor
    parse_lookup_block ()
endfunction

function pfl_parse_summary_lookup_field (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in field")
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in field")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "textual"
        elsif .[type] ?= "textbox"
        elsif .[type] ?= "numeric"
        elsif .[type] ?= "date"
        elsif .[type] ?= "time"
        elsif .[type] ?= "boolean"
        elsif .[type] ?= "timestamp"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in field")
        endif
    endif
    if defined (.[required])
        if    .[required] ?= "0"
        elsif .[required] ?= "1"
        else
            pfl_parse_error ("Attribute 'required' has illegal value '$(.[required]?)' in field")
        endif
    endif
    if defined (.[attr])
        if    .[attr] ?= "input"
        elsif .[attr] ?= "plain"
        elsif .[attr] ?= "hilite"
        elsif .[attr] ?= "title"
        elsif .[attr] ?= "click"
        else
            pfl_parse_error ("Attribute 'attr' has illegal value '$(.[attr]?)' in field")
        endif
    endif
    if defined (.[cursor])
        if    .[cursor] ?= "0"
        elsif .[cursor] ?= "1"
        else
            pfl_parse_error ("Attribute 'cursor' has illegal value '$(.[cursor]?)' in field")
        endif
    endif
    if defined (.[hidden])
        if    .[hidden] ?= "0"
        elsif .[hidden] ?= "1"
        else
            pfl_parse_error ("Attribute 'hidden' has illegal value '$(.[hidden]?)' in field")
        endif
    endif
    if defined (.[html])
        if    .[html] ?= "0"
        elsif .[html] ?= "1"
        else
            pfl_parse_error ("Attribute 'html' has illegal value '$(.[html]?)' in field")
        endif
    endif
    if defined (.[password])
        if    .[password] ?= "0"
        elsif .[password] ?= "1"
        else
            pfl_parse_error ("Attribute 'password' has illegal value '$(.[password]?)' in field")
        endif
    endif
    if defined (.[email])
        if    .[email] ?= "0"
        elsif .[email] ?= "1"
        else
            pfl_parse_error ("Attribute 'email' has illegal value '$(.[email]?)' in field")
        endif
    endif
    if defined (.[attachment])
        if    .[attachment] ?= "0"
        elsif .[attachment] ?= "1"
        else
            pfl_parse_error ("Attribute 'attachment' has illegal value '$(.[attachment]?)' in field")
        endif
    endif
    if defined (.[money])
        if    .[money] ?= "0"
        elsif .[money] ?= "1"
        else
            pfl_parse_error ("Attribute 'money' has illegal value '$(.[money]?)' in field")
        endif
    endif
    if defined (.[truncate])
        if    .[truncate] ?= "0"
        elsif .[truncate] ?= "1"
        else
            pfl_parse_error ("Attribute 'truncate' has illegal value '$(.[truncate]?)' in field")
        endif
    endif
    if defined (.[select])
        if    .[select] ?= "drop down"
        elsif .[select] ?= "radio"
        elsif .[select] ?= "radio down"
        else
            pfl_parse_error ("Attribute 'select' has illegal value '$(.[select]?)' in field")
        endif
    endif
    if defined (.[dynamic])
        if    .[dynamic] ?= "0"
        elsif .[dynamic] ?= "1"
        else
            pfl_parse_error ("Attribute 'dynamic' has illegal value '$(.[dynamic]?)' in field")
        endif
    endif
    if defined (.[case])
        if    .[case] ?= "none"
        elsif .[case] ?= "upper"
        elsif .[case] ?= "lower"
        else
            pfl_parse_error ("Attribute 'case' has illegal value '$(.[case]?)' in field")
        endif
    endif
    if defined (.[blank])
        if    .[blank] ?= "0"
        elsif .[blank] ?= "1"
        else
            pfl_parse_error ("Attribute 'blank' has illegal value '$(.[blank]?)' in field")
        endif
    endif
    if defined (.[nowrap])
        if    .[nowrap] ?= "0"
        elsif .[nowrap] ?= "1"
        else
            pfl_parse_error ("Attribute 'nowrap' has illegal value '$(.[nowrap]?)' in field")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in field")
        endif
    endif
    if (.[discrete]?"") = ""
        .[discrete] = "0"
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "rule"
        elsif name () = "value"
        else
            pfl_parse_error ("<$(name ())> not allowed in field")
        endif
    endfor

    #    Process each set of entities separately
    for [rule]
        pfl_parse_field_rule ('rule')
    endfor
    for [value]
        pfl_parse_field_value ('value')
    endfor
endfunction

function pfl_parse_summary_text (tag)
    if (.[before]?"") = ""
        .[before] = "0"
    endif
    if (.[after]?"") = ""
        .[after] = "0"
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in text")
        endif
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in text")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in text")
    endfor
endfunction

function pfl_parse_summary_action (tag)
    if !defined (.[name])
        pfl_parse_error ("Required attribute 'name' not defined in action")
    endif
    if (.[fields]?"") = ""
        .[fields] = "0"
    endif
    if defined (.[fields])
        if    .[fields] ?= "0"
        elsif .[fields] ?= "1"
        else
            pfl_parse_error ("Attribute 'fields' has illegal value '$(.[fields]?)' in action")
        endif
    endif
    if defined (.[type])
        if    .[type] ?= "link"
        elsif .[type] ?= "button"
        elsif .[type] ?= "image"
        else
            pfl_parse_error ("Attribute 'type' has illegal value '$(.[type]?)' in action")
        endif
    endif
    if (.[style]?"") = ""
        .[style] = "action"
    endif
    if (.[confirm]?"") = ""
        .[confirm] = ""
    endif
    if (.[join]?"") = ""
        .[join] = "0"
    endif
    if defined (.[join])
        if    .[join] ?= "0"
        elsif .[join] ?= "1"
        else
            pfl_parse_error ("Attribute 'join' has illegal value '$(.[join]?)' in action")
        endif
    endif
    if defined (.[align])
        if    .[align] ?= "left"
        elsif .[align] ?= "middle"
        elsif .[align] ?= "right"
        else
            pfl_parse_error ("Attribute 'align' has illegal value '$(.[align]?)' in action")
        endif
    endif
    if defined (.[toolbar])
        if    .[toolbar] ?= "0"
        elsif .[toolbar] ?= "1"
        else
            pfl_parse_error ("Attribute 'toolbar' has illegal value '$(.[toolbar]?)' in action")
        endif
    endif
    if (.[active]?"") = ""
        .[active] = "1"
    endif
    if defined (.[active])
        if    .[active] ?= "0"
        elsif .[active] ?= "1"
        else
            pfl_parse_error ("Attribute 'active' has illegal value '$(.[active]?)' in action")
        endif
    endif
    if (.[shortcut]?"") = ""
        .[shortcut] = ""
    endif
    if defined (.[separator])
        if    .[separator] ?= "0"
        elsif .[separator] ?= "1"
        else
            pfl_parse_error ("Attribute 'separator' has illegal value '$(.[separator]?)' in action")
        endif
    endif
    action_defaults ()
    for .
        pfl_parse_error ("<$(name ())> not allowed in action")
    endfor
endfunction

function pfl_parse_summary_if_block (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    if !defined (condition)
        pfl_parse_error ("no condition defined for if block")
    endif
    pfl_parse_summary_element ('if')
endfunction

function pfl_parse_page_index (tag)
    index.name ?= "$(page.Name)"
    for .
        pfl_parse_error ("<$(name ())> not allowed in index")
    endfor
endfunction

function pfl_parse_screen_handler (tag)
    if defined (.[event])
        if    .[event] ?= "on_global"
        elsif .[event] ?= "on_init"
        elsif .[event] ?= "on_exit"
        elsif .[event] ?= "on_return"
        elsif .[event] ?= "on_returnto"
        elsif .[event] ?= "on_savecontext"
        elsif .[event] ?= "on_loadcontext"
        elsif .[event] ?= "on_clrcontext"
        elsif .[event] ?= "on_oalerror"
        elsif .[event] ?= "on_fetch"
        elsif .[event] ?= "on_create"
        elsif .[event] ?= "on_update"
        elsif .[event] ?= "on_accept"
        elsif .[event] ?= "on_delete"
        elsif .[event] ?= "on_lookup"
        elsif .[event] ?= "on_chainto"
        elsif .[event] ?= "on_action"
        elsif .[event] ?= "on_initpage"
        elsif .[event] ?= "on_showpage"
        elsif .[event] ?= "on_getdata"
        elsif .[event] ?= "on_title"
        elsif .[event] ?= "on_toolbar"
        elsif .[event] ?= "on_click"
        elsif .[event] ?= "on_select"
        elsif .[event] ?= "on_goback"
        elsif .[event] ?= "on_showrow"
        elsif .[event] ?= "on_filter"
        else
            pfl_parse_error ("Attribute 'event' has illegal value '$(.[event]?)' in handler")
        endif
    endif
    if (.[getdata]?"") = ""
        .[getdata] = "1"
    endif
    if defined (.[getdata])
        if    .[getdata] ?= "0"
        elsif .[getdata] ?= "1"
        else
            pfl_parse_error ("Attribute 'getdata' has illegal value '$(.[getdata]?)' in handler")
        endif
    endif
    if defined (action) & count (screen.handler, count.action ?= handler.action) > 1
        pfl_parse_error ("handler for '$(action)' is not unique in screen")
    endif
    handler.getdata ?= 1
    if defined (page)
        for screen.page where name = page
            if (append?0) = 0
                for handler as page_handler where \
                    (defined (page_handler.action) & action ?= handler.action) | \
                    (defined (page_handler.event)  & event ?=  handler.event)
                    delete page_handler
                endfor
            endif
            handler.tag = "this"
            copy handler to page
            for handler where tag ?= "this"
                pfl_parse_page_handler ("handler")
                handler.tag = undef?
            endfor
        endfor
    elsif defined (action)
        if substr (action,0,2,) = "on_"
            echo "Warning: in $(screen.name), action '$(action)' looks like an event"
        endif
    elsif defined (event)
        if event = "on_fetch"
            if !defined (handler.object)
                if count (screen.use)
                    handler.object = screen-> use.object
                endif
            endif
            if !defined (handler.view)
                if count (screen.page)
                    handler.view = screen-> page.view
                endif
            endif
        endif
    else
        pfl_parse_error ("handler must specify either action or event")
    endif
    pfl_parse_handler_statement ('handler')
    if defined (page)
        delete handler
    endif
endfunction

function pfl_parse_page_handler (tag)
    if defined (.[event])
        if    .[event] ?= "on_initpage"
        elsif .[event] ?= "on_showpage"
        elsif .[event] ?= "on_getdata"
        elsif .[event] ?= "on_title"
        elsif .[event] ?= "on_toolbar"
        elsif .[event] ?= "on_click"
        elsif .[event] ?= "on_select"
        elsif .[event] ?= "on_goback"
        elsif .[event] ?= "on_showrow"
        else
            pfl_parse_error ("Attribute 'event' has illegal value '$(.[event]?)' in handler")
        endif
    endif
    if (.[getdata]?"") = ""
        .[getdata] = "1"
    endif
    if defined (.[getdata])
        if    .[getdata] ?= "0"
        elsif .[getdata] ?= "1"
        else
            pfl_parse_error ("Attribute 'getdata' has illegal value '$(.[getdata]?)' in handler")
        endif
    endif
    if defined (action) & count (page.handler, count.action ?= handler.action) > 1
        pfl_parse_error ("handler for '$(action)' is not unique in page")
    endif
    handler.getdata ?= 1
    if defined (action)
        if substr (action,0,2,) = "on_"
            echo "Warning: in $(screen.name), action '$(action)' looks like an event"
        endif
    elsif !defined (event)
        pfl_parse_error ("handler must specify either action or event")
    endif
    pfl_parse_handler_statement ('handler')
endfunction

function pfl_parse_handler_statement (tag)
    #    Check that all entities are valid here
    for . as entity
        if    name () = "query"
        elsif name () = "create"
        elsif name () = "fetch"
        elsif name () = "update"
        elsif name () = "delete"
        elsif name () = "import"
        elsif name () = "step"
        elsif name () = "if"
        elsif name () = "save"
        else
            pfl_parse_error ("<$(name ())> not allowed in handler statement")
        endif
    endfor

    #    Process each set of entities separately
    for [query]
        pfl_parse_query_statement ('query')
    endfor
    for [create]
        pfl_parse_create_statement ('create')
    endfor
    for [fetch]
        pfl_parse_fetch_statement ('fetch')
    endfor
    for [update]
        pfl_parse_update_statement ('update')
    endfor
    for [delete]
        pfl_parse_delete_statement ('delete')
    endfor
    for [import]
        pfl_parse_import_statement ('import')
    endfor
    for [step]
        pfl_parse_step_statement ('step')
    endfor
    for [if]
        pfl_parse_if_statement ('if')
    endfor
    for [save]
        pfl_parse_save_statement ('save')
    endfor
endfunction

function pfl_parse_query_statement (tag)
    if (.[control]?"") = ""
        .[control] = "first"
    endif
    if defined (.[control])
        if    .[control] ?= "first"
        elsif .[control] ?= "last"
        elsif .[control] ?= "gt"
        elsif .[control] ?= "lt"
        elsif .[control] ?= "ge"
        elsif .[control] ?= "le"
        elsif .[control] ?= "eq"
        elsif .[control] ?= "same"
        else
            pfl_parse_error ("Attribute 'control' has illegal value '$(.[control]?)' in query")
        endif
    endif
    if defined (query.object)
        if count (screen.use, count.object = query.object) = 0
            pfl_parse_error ("query object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            query.object = screen-> use.object
        else
            pfl_parse_error ("no object specified for query or for screen")
        endif
    endif
    query.limit ?= screen.limit? 20
    query.name  ?= screen.query? "summary"
    for ofl.object where name = object
        if count (query, count.name = query.name) = 0
            pfl_parse_error ("query '$(query.name)' does not exist in $(object)")
        endif
        for query as objquery where name = query.name
            query.view  = objquery.view
            query.index = objquery.index
            objquery.used = 1
        endfor
    endfor
    #   Inherit match and queryarg information from screen
    for screen.match    where count (query.match,    count.name = match.name) = 0
        copy match to query
    endfor
    for screen.queryarg where count (query.queryarg, count.name = queryarg.name) = 0
        copy queryarg to query
    endfor
    if count (screen.query, count.name = query.name & count.object = query.object) = 0
        if defined (query.view)
            copy query to screen
            assume_screen_view (object, query.view)
        endif
    endif
    if count (found) > 1
        pfl_parse_error ("more than one <found> defined in query")
    endif
    if count (each) > 1
        pfl_parse_error ("more than one <each> defined in query")
    endif
    if count (empty) > 1
        pfl_parse_error ("more than one <empty> defined in query")
    endif
    if count (error) > 1
        pfl_parse_error ("more than one <error> defined in query")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "match"
        elsif name () = "queryarg"
        elsif name () = "found"
        elsif name () = "each"
        elsif name () = "empty"
        elsif name () = "error"
        else
            pfl_parse_error ("<$(name ())> not allowed in query")
        endif
    endfor

    #    Process each set of entities separately
    for [match]
        pfl_parse_match ('match')
    endfor
    for [queryarg]
        pfl_parse_queryarg ('queryarg')
    endfor
    for [found]
        pfl_parse_found_statement ('found')
    endfor
    for [each]
        pfl_parse_each_statement ('each')
    endfor
    for [empty]
        pfl_parse_empty_statement ('empty')
    endfor
    for [error]
        pfl_parse_error_statement ('error')
    endfor
endfunction

function pfl_parse_found_statement (tag)
    pfl_parse_handler_statement ('found')
endfunction

function pfl_parse_each_statement (tag)
    pfl_parse_handler_statement ('each')
endfunction

function pfl_parse_empty_statement (tag)
    pfl_parse_handler_statement ('empty')
endfunction

function pfl_parse_create_statement (tag)
    if defined (create.object)
        if count (screen.use, count.object = create.object) = 0
            pfl_parse_error ("create object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            create.object = screen-> use.object
        else
            pfl_parse_error ("no object specified for create or for screen")
        endif
    endif
    assume_screen_view (object, "create")
    if count (ok) > 1
        pfl_parse_error ("more than one <ok> defined in create")
    endif
    if count (error) > 1
        pfl_parse_error ("more than one <error> defined in create")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "ok"
        elsif name () = "error"
        else
            pfl_parse_error ("<$(name ())> not allowed in create")
        endif
    endfor

    #    Process each set of entities separately
    for [ok]
        pfl_parse_ok_statement ('ok')
    endfor
    for [error]
        pfl_parse_error_statement ('error')
    endfor
endfunction

function pfl_parse_ok_statement (tag)
    pfl_parse_handler_statement ('ok')
endfunction

function pfl_parse_error_statement (tag)
    pfl_parse_handler_statement ('error')
endfunction

function pfl_parse_fetch_statement (tag)
    if (.[view]?"") = ""
        .[view] = "detail"
    endif
    if defined (fetch.object)
        if count (screen.use, count.object = fetch.object) = 0
            pfl_parse_error ("fetch object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            fetch.object = screen-> use.object
        else
            pfl_parse_error ("no object specified for fetch or for screen")
        endif
    endif
    assume_screen_view (object, fetch.view)
    if count (ok) > 1
        pfl_parse_error ("more than one <ok> defined in fetch")
    endif
    if count (missing) > 1
        pfl_parse_error ("more than one <missing> defined in fetch")
    endif
    if count (error) > 1
        pfl_parse_error ("more than one <error> defined in fetch")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "ok"
        elsif name () = "missing"
        elsif name () = "error"
        else
            pfl_parse_error ("<$(name ())> not allowed in fetch")
        endif
    endfor

    #    Process each set of entities separately
    for [ok]
        pfl_parse_ok_statement ('ok')
    endfor
    for [missing]
        pfl_parse_missing_statement ('missing')
    endfor
    for [error]
        pfl_parse_error_statement ('error')
    endfor
endfunction

function pfl_parse_missing_statement (tag)
    pfl_parse_handler_statement ('missing')
endfunction

function pfl_parse_update_statement (tag)
    if (.[view]?"") = ""
        .[view] = "detail"
    endif
    if defined (update.object)
        if count (screen.use, count.object = update.object) = 0
            pfl_parse_error ("update object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            update.object = screen-> use.object
        else
            pfl_parse_error ("no object specified for update or for screen")
        endif
    endif
    assume_screen_view (object, update.view)
    if count (ok) > 1
        pfl_parse_error ("more than one <ok> defined in update")
    endif
    if count (error) > 1
        pfl_parse_error ("more than one <error> defined in update")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "ok"
        elsif name () = "error"
        else
            pfl_parse_error ("<$(name ())> not allowed in update")
        endif
    endfor

    #    Process each set of entities separately
    for [ok]
        pfl_parse_ok_statement ('ok')
    endfor
    for [error]
        pfl_parse_error_statement ('error')
    endfor
endfunction

function pfl_parse_delete_statement (tag)
    if defined ([delete].object)
        if count (screen.use, count.object = [delete].object) = 0
            pfl_parse_error ("delete object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            [delete].object = screen-> use.object
        else
            pfl_parse_error ("no object specified for delete or for screen")
        endif
    endif
    if count (ok) > 1
        pfl_parse_error ("more than one <ok> defined in delete")
    endif
    if count (error) > 1
        pfl_parse_error ("more than one <error> defined in delete")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "ok"
        elsif name () = "error"
        else
            pfl_parse_error ("<$(name ())> not allowed in delete")
        endif
    endfor

    #    Process each set of entities separately
    for [ok]
        pfl_parse_ok_statement ('ok')
    endfor
    for [error]
        pfl_parse_error_statement ('error')
    endfor
endfunction

function pfl_parse_import_statement (tag)
    if defined (import.object)
        if count (screen.use, count.object = import.object) = 0
            pfl_parse_error ("import object '$(object)' not in screen 'use' list")
        endif
    else
        if count (screen.use)
            import.object = screen-> use.object
        else
            pfl_parse_error ("no object specified for import or for screen")
        endif
    endif
    for .
        pfl_parse_error ("<$(name ())> not allowed in import")
    endfor
endfunction

function pfl_parse_step_statement (tag)
    pfl_parse_handler_statement ('step')
endfunction

function pfl_parse_if_statement (tag)
    if !defined (.[condition])
        pfl_parse_error ("Required attribute 'condition' not defined in if")
    endif
    pfl_parse_handler_statement ('if')
endfunction

function pfl_parse_save_statement (tag)
    pfl_parse_handler_statement ('save')
endfunction

function pfl_parse_defaults (tag)
    if count (page) < 1
        pfl_parse_error ("<page> required in defaults")
    endif
    #    Check that all entities are valid here
    for . as entity
        if    name () = "property"
        elsif name () = "use"
        elsif name () = "var"
        elsif name () = "enum"
        elsif name () = "global"
        elsif name () = "match"
        elsif name () = "queryarg"
        elsif name () = "page"
        elsif name () = "handler"
        else
            pfl_parse_error ("<$(name ())> not allowed in defaults")
        endif
    endfor

    #    Process each set of entities separately
    for [property]
        pfl_parse_property ('property')
    endfor
    for [use]
        pfl_parse_use ('use')
    endfor
    for [var]
        pfl_parse_var ('var')
    endfor
    for [enum]
        pfl_parse_enum ('enum')
    endfor
    for [global]
        pfl_parse_global ('global')
    endfor
    for [match]
        pfl_parse_match ('match')
    endfor
    for [queryarg]
        pfl_parse_queryarg ('queryarg')
    endfor
    for [page]
        pfl_parse_page ('page')
    endfor
    for [handler]
        pfl_parse_screen_handler ('handler')
    endfor
endfunction

function pfl_parse_property (tag)
    for .
        pfl_parse_error ("<$(name ())> not allowed in property")
    endfor
endfunction


function action_defaults ()
    action.text  ?= "$(action.name:neat)"
    action.image ?= "$(name)"
    action.hint  ?= text
    if mode ?= "input"
        action.type ?= "button"
    else
        action.type ?= "link"
    endif
    if action.toolbar ?= 1 
        if count (page.toolbar) \
        &  count (page-> toolbar.action, count.name = action.name) = 0
            copy action to page-> toolbar
        endif
    endif
    if name <> "" & count (screen.handler, count.action ?= name) = 0
        if count (page.handler, count.action ?= name) = 0
            pfl_parse_error ("no handler for action '$(name:)'")
        else
            for page.handler where action ?= name
                handler.fields = action.fields
            endfor
        endif
    endif
endfunction

function expand_wildcards_if_any ()
    if count (field) = 1
       for field as wildcard where name = "*"
          for ofl.object where name = object
          for view       where name = view
             for view-> table.field as viewfield
                new field before wildcard
                   field.name   = viewfield.name
                   field.object = object
                   field.view   = view
                   #   Expand lookup tables if any exist in view
                   if count (viewfield.table, type = "lookup")
                      for viewfield.table where type = "lookup"
                         new lookup to field
                            for table.field as lookupfield
                               if (lookupfield.auto?0) = 0
                                  new field to lookup
                                     field.name   = lookupfield.name
                                     field.object = object
                                     field.view   = view
                                  endnew
                               endif
                            endfor
                         endnew
                      endfor
                   endif
                endnew
             endfor
          endfor
          endfor
       endfor
    endif
    for field where name = "*"
        delete field
    endfor
endfunction

function parse_top_level_field (style)
    if defined (view)
        #   Object and view can be set at field or page level
        for ofl.object where name = object
        for view       where name = view
            for view-> table.field as viewfield where name = field.name
                set_field_from_object (style)
                #   If field has child tables, parse lookups and sublists
                parse_field_subtables ("child",  "sublist", "summary")
                parse_field_subtables ("lookup", "lookup",  style)
            endfor
        endfor
        endfor
    endif
    if defined (field.view)
        field.varname = "fld_$(object)_$(field.name)"
    else
        field.varname = "fld_$(field.name)"
    endif
    set_field_defaults (style)

    #   Allow type and default to be put either in field or var
    #   var value overrides field default, and field type overrides
    #   var type.
    for screen.var where name = field.varname
        if defined (field.type)
            var.type = field.type
        else
            field.type = var.type
        endif
        if defined (var.value)
            field.default = var.value
        else
            var.value = field.default
        endif
        field.occurs ?= var.occurs?
    endfor

    if count (screen.var, count.name = field.varname) = 0
        if !defined (field.view)
            echo "Warning: undeclared var '$(field.varname)' in $(screen.name)"
        endif
        new var to screen
            var.name  = field.varname
            var.type  = field.type
            var.value = field.default
        endnew
    endif
    if count (page.field, count.name = field.name & count.object?"" = field.object?"")
        pfl_parse_error ("'$(field.name)' duplicated in $(page.name)")
    else
        copy field to page
    endif
endfunction        

function parse_field_subtables (subtable, subblock, style)
    #   Go through field subtables in view
    for viewfield.table as viewtable where type = subtable
        #   and now in parallel, through field subblock on screen
        parent = field.name
        parent_label = field.label?
        for field.$(subblock)
            $(subblock).table ?= viewtable.name
            $(subblock).processed = 1
            if $(subblock).table <> viewtable.name
                last
            endif
            for $(subblock).field
                #   Now find view field that matches our field
                for viewtable.field as viewfield where name = field.name
                    set_field_from_object (style)
                endfor
                field.varname = "fld_$(object)_$(parent)_$(field.name)"
                #   Parent label overrides child label in lookups
                field.label  ?= parent_label?
                set_field_defaults (style)
            endfor
        endfor
    endfor
    for field.$(subblock) where !defined (processed)
        pfl_parse_error ("'$(field.name)' has no $(subblock) defined in the $(view) view")
    endfor
endfunction

function set_field_from_object (style)
    #   Get presentation-level attributes for this field
    for rule where name = "show" & (when = style | when = "all")
        field.$(what) ?= value
    endfor
    field.object   ?= object
    field.view     ?= view
    field.type     ?= viewfield.type
    field.size     ?= viewfield.size?
    field.decs     ?= viewfield.decs?
    field.required ?= viewfield.required?0
    field.default  ?= viewfield.default?
    field.hidden   ?= viewfield.hidden?0
    field.         ?= viewfield.?
    #   Get list of select values
    if count (field.value) = 0
        for value
            copy value to field
        endfor
    endif
endfunction

function set_field_defaults (style)
    #   Inherit field properties from domain if specified
    if defined (field.domain)
        if count (dfl.domain, count.name = field.domain) = 0
            pfl_parse_error ("Domain '$(domain)' not found in DFL")
        endif
        for dfl.domain where name = field.domain
            #   Get presentation-level attributes for this field
            for rule where name = "show" & (when = style | when = "all")
                field.$(what) ?= value
            endfor
            field.type     ?= domain.type?
            field.size     ?= domain.size?
            field.decs     ?= domain.decs?
            field.default  ?= domain.default?
            field.required ?= domain.required?
            field.         ?= domain.?
            #   Get list of select values
            if count (field.value) = 0
                for value
                    copy value to field
                endfor
            endif
        endfor
    endif

    field.type ?= "textual"
    if type = "textual"
        field.size     ?= 40
        field.showsize ?= field.size
        field.default  ?= ""
        if (attachment?0 = 0) & (showsize > 60 | defined (rows) | defined (cols))
            field.type = "textbox"
            field.cols ?= 50
            field.html ?= 1
            if style = "summary"
                field.rows ?= 1
            else
                field.rows ?= 2
            endif
        endif
    elsif type = "textbox"
        if style = "summary"
            field.rows ?= 1
        else
            field.rows ?= 4
        endif
        field.cols     ?= 60
        field.default  ?= ""
        field.size     ?= rows * cols
        field.html     ?= 1
    elsif type = "numeric"
        field.size     ?= 10
        field.decs     ?= 0
        field.showsize ?= field.size
        field.default  ?= 0
        if showsize > 15
            showsize = 15
        endif
    else
        field.default  ?= 0
    endif
    if !defined (field.label)
        label = trim (field.?"")
        if label = ""
            field.label = field.name
        endif
        field.label = "$(substr (label,0,,1):neat)" + substr (label,1,,)
    endif
    if form.mode = "output"
        field.attr ?= "plain"
    else
        field.attr ?= "input"
    endif
    field.join   ?= 0

    if count (lookup)
        if field.type = "textual"
            field.hidden ?= 0
        else
            field.hidden = 1
        endif
    else
        field.hidden ?= 0
    endif
    if field.attachment ?= 1
        screen.has_attachments = 1
    endif
    if count (value)
        field.select ?= "drop down"
    endif
    if count (value)
        if count (screen.value_set, count.name = field.name) = 0
            copy field to screen as value_set
        endif
    endif
endfunction

function parse_lookup_block ()
    if !defined (page.view)
        pfl_parse_error ("no view is defined for page '$(page.name)'")
    endif        
    if count (screen.lookup, count.name = field.name) = 0
        new lookup to screen as screenlookup
            screenlookup.name    = field.name
            screenlookup.varname = field.varname
            screenlookup.object  = lookup.table?
            screenlookup.select  = lookup.select? "$(lookup.table?)_select"
            if !defined (lookup.table)
                pfl_parse_error ("'$(field.name)' cannot be used as lookup in $(view) view")
            endif
        endnew
    endif
    for screen.lookup as screenlookup where name = field.name
        for lookup.field
            if count (screenlookup.field, name = field.name) = 0
                copy field to screenlookup
            endif
        endfor
    endfor
endfunction

function assume_screen_view (p_object, p_view)
    if !defined (p_object)
        pfl_parse_error ("No object defined for view '$(p_view)'")
    endif    
    if count (screen.view, count.object = p_object & count.name = p_view) = 0
        new view to screen
            view.object = p_object
            view.name   = p_view
        endnew

        #   Ensure all object fields are defined as variables
        for ofl.object where name = p_object
        for view       where name = p_view
            for view-> table.field
                varname = "fld_$(p_object)_$(field.name)"
                if count (screen.var, count.name = varname) = 0
                    new var to screen 
                        var.name  = varname
                        var.type  = field.type
                        var.value = field.default
                    endnew
                endif
                #   Expose all child table fields as variables
                for table 
                    parent = field.name
                    for field
                        varname = "fld_$(p_object)_$(parent)_$(field.name)"
                        if count (screen.var, count.name = varname) = 0
                            new var to screen 
                                var.name   = varname
                                var.type   = field.type
                                var.value  = field.default
                                var.occurs = table.occurs?
                            endnew
                        endif
                    endfor
                endfor
            endfor
        endfor
        endfor
    endif
endfunction


function pfl_parse_error (p_message)
    #   GSL has bug in parameter passing...
    if !defined (p_message)
        p_message = "(Unknown error)"
    endif
    if defined (page.name)
        message = "$(screen.name) ($(page.name)): $(p_message:)"
    else
        message = "$(screen.name): $(p_message:)"
    endif
    error (message)
endfunction

